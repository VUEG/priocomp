---
title: "Exploring patterns in data"
author: "Joona Lehtom√§ki"
date: "`r Sys.Date()`"
output:
  html_document: 
    highlight: tango
    theme: flatly
  html_notebook: default
---

```{r setup, echo=FALSE,message=FALSE,warning=FALSE}
library(grid)
library(gridExtra)
library(knitr)
library(raster)
library(rasterVis)
library(viridis)

options(scipen = 9999)
# Search for datasets. HACK: dealing with path depedning on whether we're running
# in the RStudio project root "priocomp" or Knitr folder "reports".
if (basename(getwd()) == "priocomp") {
  data_path <- "data"
} else {
  data_path <- "../../data"
}

# Helper functions --------------------------------------------------------------

# Normalize raster values into [0, 1]
normalize <- function(x) {
  min <- raster::minValue(x)
  max <- raster::maxValue(x)
  return((x - min) / (max - min))
}

# Read in and normalize a raster
process_raster <- function(x) {
  # Min/max is not set in some cases
  x <- raster::setMinMax(raster::raster(x))
  x <- normalize(x)
  return(x)
}

# Read in data ------------------------------------------------------------------
data_files <- list.files(file.path(data_path, "processed/features/provide"), 
                             pattern = ".\\.tif$", recursive = TRUE, 
                             full.names = TRUE)
# Create a raster stack (NOTE! Extents may be different)
es_rasters <- raster::stack(lapply(data_files[c(1, 4, 5)], process_raster))
```

## Distributional patterns and occurrence of 3 ecosystem service features

All the features below have been normalized into $[0, 1]$, so the original units do not 
matter. What matters: 

1. **Spatial patterns** of values within and among features, and
2. **Occurrence levels** of features, or the absolute amount of informative cells and their values relative to others.

Have a look at the 3 different types of features, the question is in the end.

### Spatial patterns

In the figures below, marginal plots (both on x- and y-axis) describe the the mean value
over columns (x) and rows (y).

#### A: Carbon sequestration

```{r plot1, echo=FALSE}
rasterVis::levelplot(es_rasters[[1]], main = paste(LETTERS[1], "-", 
                                                   names(es_rasters[[1]])), 
                     margin = list(FUN = 'mean'), col.regions = viridis)
```

Feature is fairly evenly distributed over the whole area of interes with variation both 
globally and locally. Roughly speaking, value distributions on both x- and y-axes are
multimodal (or even uniform).

#### B: Erosion prevention

```{r plot2, echo=FALSE}
rasterVis::levelplot(es_rasters[[2]], main = paste(LETTERS[2], "-", 
                                                   names(es_rasters[[2]])), 
                     margin = list(FUN = 'mean'), col.regions = viridis)
```

Feature is very unevenly distributed over the area of interest. The values distribution 
is multimodal characterized by large relative differences in values (spikes). In other 
words, the occurrence is very localized. **Note** that  the color scaling is different to 
those of A and C.

#### C: Flood control

```{r plot3, echo=FALSE}
rasterVis::levelplot(es_rasters[[3]], main = paste(LETTERS[3], "-", 
                                                   names(es_rasters[[3]])), 
                     margin = list(FUN = 'mean'), col.regions = viridis)
```

Feature can be found throughout the area of interest, but the distribution is concentrated
in the central parts. Hence, local variation is medium or low, but global variation high.
Approximating a little, the value distributions are unimodal.

### Occurrence levels

Since the marginal plots in the figures above are not necessarily on the same scale
(even if the data are after normalization), they cannot be directly compared to get
and idea about how common/rare a given feature is. Visual inspection will already 
hint order `floodregulation` > `carbon_sequestration` > `erosion_prevention`. Another way 
of characterizing this is to have a look at the *distribution sum (DS)* of each feature, 
which is simply the sum of all values over the whole feature:

```{r distributional-sum, echo=FALSE}

ds <- sapply(as.list(es_rasters), function(x) sum(raster::getValues(x), na.rm = TRUE))
ds_df <- data.frame(raster = names(es_rasters),
                    ds = round(ds, 1))
ds_df <- ds_df[with(ds_df, order(-ds)), ]
knitr::kable(ds_df, col.names = c("Feature", "Distribution sum"), align = c("l", "l"),
             row.names = FALSE)
```

DS of `floodregulation` is ~`r round(ds_df[1, ]$ds / ds_df[2, ]$ds, 0)` and ~`r round(ds_df[1, ]$ds / ds_df[3, ]$ds, 0)` times greater than that of `carbon_sequestration` and `erosion_prevention`,
respectively.

## Question

Given the different types (the typology is not exhaustive) of feature described above:

**Do you know of any quantitative methods that would characterize both the spatial pattern and the occurrence levels of continuous rasters in  some concise way? Furthermore, do you know software implementations of these methods?**

Some sort of scalar measure, or set of measures would be best. It would have
to take into consideration continuous data, so most e.g. most landscape ecological 
measures looking at discrete features are not ideal. Of course, it would be possible to 
categorize the features somehow. Any possible measures are probably going to be 
scale-dependent, but such is life. I keep coming back to two broad analysis categories: 
fractal analysis (e.g. lacunarity analysis) and pattern recognition (e.g. FFT methods). 
Unfortunately, I have very limited experience in either.

